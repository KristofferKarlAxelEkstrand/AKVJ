name: PR Thread Check

on:
    pull_request:
        types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
    check-resolved-threads:
        runs-on: ubuntu-latest
        permissions:
            pull-requests: read
            contents: read
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Verify resolved PR review threads include justification or commit reference
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      // NOTE: `actions/github-script` injects helpers (core, github, context)
                      // Do not `require('@actions/core')` inside this inline script —
                      // re-declaring `core` will throw a SyntaxError.
                      try {
                        const owner = context.repo.owner;
                        const repo = context.repo.repo;
                        const prNumber = context.payload.pull_request && context.payload.pull_request.number;

                        if (!prNumber) {
                          core.setFailed('No pull request context was found for this event.');
                          return;
                        }

                        // GraphQL query for PR review threads
                        const query = `
                          query($owner: String!, $repo: String!, $prNumber: Int!) {
                            repository(owner: $owner, name: $repo) {
                              pullRequest(number: $prNumber) {
                                reviewThreads(first: 250) {
                                  nodes {
                                    id
                                    isResolved
                                    comments(first: 50) {
                                      nodes {
                                        body
                                        author { login }
                                        createdAt
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        `;

                        const data = await github.graphql(query, { owner, repo, prNumber });

                        if (!data || !data.repository || !data.repository.pullRequest) {
                          core.setFailed('Could not retrieve pull request data for this event.');
                          return;
                        }

                        const threads = (data.repository.pullRequest.reviewThreads && data.repository.pullRequest.reviewThreads.nodes) || [];

                        const resolvedThreadsMissingJustification = [];

                        const commitOrKeyword = /[0-9a-f]{7,40}|\b(Decline|Declined|won'?t fix|won'?t-fix|Outdated|Resolved|Done|Done —|Done:|Done -)\b/i;

                        for (const t of threads) {
                          if (!t.isResolved) continue;

                          // Try to find a comment that provides a closure justification
                          const comments = (t.comments && t.comments.nodes) || [];
                          const hasJustification = comments.some(c => commitOrKeyword.test(c.body || ''));

                          if (!hasJustification) {
                            // Capture last few comments to give context in the failure message
                            const lastComments = comments.slice(-3).map(c => `${c.createdAt || 'unknown'} ${c.author?.login || 'unknown'}: ${c.body?.slice(0, 120) || ''}`);
                            resolvedThreadsMissingJustification.push({ id: t.id, commentsCount: comments.length, sampleComments: lastComments });
                          }
                        }

                        if (resolvedThreadsMissingJustification.length > 0) {
                          console.log('Resolved threads missing justification:');
                          for (const r of resolvedThreadsMissingJustification) {
                            console.log(` - thread ${r.id} (${r.commentsCount} comments)`);
                            for (const c of r.sampleComments) console.log(`     ${c}`);
                          }
                          core.setFailed(`There are ${resolvedThreadsMissingJustification.length} resolved review thread(s) without a justification comment. Please leave a brief comment (commit SHA, "Decline — won't fix", "Outdated", "Resolved", or similar) when resolving threads.`);
                        } else {
                          console.log('All resolved review threads appear to have a justification comment or commit reference.');
                        }
                      } catch (err) {
                        core.setFailed(`Error while checking resolved PR threads: ${err && err.message ? err.message : String(err)}`);
                      }
